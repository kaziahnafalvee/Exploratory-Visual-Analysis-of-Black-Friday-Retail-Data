<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Bangladesh Weather Profile Explorer</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    body {
      font-family: sans-serif;
      text-align: center;
      margin: 20px;
      background: #fdfdfd;
    }
    #vis {
      display: flex;
      justify-content: center;
      gap: 30px;
      margin-top: 20px;
    }
    svg {
      border: 1px solid #ccc;
      background: #f0f0f0;
    }
    .tooltip {
      position: absolute;
      background: #fff;
      border: 1px solid #ccc;
      padding: 5px 10px;
      font-size: 13px;
      pointer-events: none;
      border-radius: 4px;
      box-shadow: 0 0 5px rgba(0,0,0,0.2);
    }
  </style>
</head>
<body>
  <h2>Bangladesh Weather Profile Explorer</h2>
  <div id="vis">
    <svg id="map" width="600" height="500"></svg>
    <svg id="chart" width="400" height="400"></svg>
  </div>

  <script>
    const mapSvg = d3.select("#map");
    const chartSvg = d3.select("#chart");
    const width = 600, height = 500;
    const projection = d3.geoMercator()
      .center([90.35, 23.685])
      .scale(5000)
      .translate([width / 2, height / 2]);
    const path = d3.geoPath().projection(projection);

    const tooltip = d3.select("body").append("div")
      .attr("class", "tooltip")
      .style("opacity", 0);

    Promise.all([
      d3.json("data/bd_districts.geojson"),
      d3.csv("data/bd_city_coords.csv"),
      d3.csv("data/bd_weather_summary.csv")
    ]).then(([geoData, coords, weather]) => {
      const cityWeather = {};
      weather.forEach(d => cityWeather[d.City] = d);

      mapSvg.selectAll("path")
        .data(geoData.features)
        .enter().append("path")
        .attr("d", path)
        .attr("fill", "#ddd")
        .attr("stroke", "#999");

      mapSvg.selectAll("circle")
        .data(coords)
        .enter().append("circle")
        .attr("cx", d => projection([+d.Longitude, +d.Latitude])[0])
        .attr("cy", d => projection([+d.Longitude, +d.Latitude])[1])
        .attr("r", 5)
        .attr("fill", "#007acc")
        .style("cursor", "pointer")
        .on("mouseover", (event, d) => {
          tooltip.style("opacity", 1)
            .html(d.City)
            .style("left", (event.pageX + 10) + "px")
            .style("top", (event.pageY - 20) + "px");
        })
        .on("mouseout", () => tooltip.style("opacity", 0))
        .on("click", (event, d) => {
          if (cityWeather[d.City]) {
            drawDonutChart(cityWeather[d.City], d.City);
          }
        });

      // Auto-load first city
      const firstCity = coords[0].City;
      drawDonutChart(cityWeather[firstCity], firstCity);
    });

    function drawDonutChart(cityData, cityName) {
      chartSvg.selectAll("*").remove();
      const radius = 150;
      const color = d3.scaleOrdinal()
        .domain(["Winter", "Pre-Monsoon", "Monsoon", "Post-Monsoon"])
        .range(["#1f77b4", "#ff7f0e", "#2ca02c", "#d62728"]);

      const data = [
        { label: "Winter", value: +cityData.Winter },
        { label: "Pre-Monsoon", value: +cityData.PreMonsoon },
        { label: "Monsoon", value: +cityData.Monsoon },
        { label: "Post-Monsoon", value: +cityData.PostMonsoon }
      ];

      const pie = d3.pie().value(d => d.value);
      const arc = d3.arc().innerRadius(70).outerRadius(radius);
      const g = chartSvg.append("g")
        .attr("transform", `translate(200,200)`);

      const arcs = g.selectAll("arc")
        .data(pie(data))
        .enter().append("g");

      arcs.append("path")
        .attr("fill", d => color(d.data.label))
        .transition().duration(800)
        .attrTween("d", function(d) {
          const i = d3.interpolate({ startAngle: 0, endAngle: 0 }, d);
          return t => arc(i(t));
        });

      arcs.append("text")
        .attr("transform", d => `translate(${arc.centroid(d)})`)
        .attr("text-anchor", "middle")
        .style("font-size", "12px")
        .text(d => d.data.label);

      // Tooltip on chart slice
      arcs.on("mouseover", (event, d) => {
          tooltip.style("opacity", 1)
            .html(`${d.data.label}: ${d.data.value} mm`)
            .style("left", (event.pageX + 10) + "px")
            .style("top", (event.pageY - 20) + "px");
        })
        .on("mouseout", () => tooltip.style("opacity", 0));

      // City label in center
      g.append("text")
        .attr("text-anchor", "middle")
        .style("font-size", "20px")
        .style("font-weight", "bold")
        .attr("dy", "0.3em")
        .text(cityName);
    }
  </script>
</body>
</html>
